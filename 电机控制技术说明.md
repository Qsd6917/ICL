# 电机控制与编码器映射技术说明

## 目标
- 电机控制参数配置化，支持驱动与零速模式切换
- 按引脚表重映射编码器通道，保持与硬件一致
- 统一 PWM 周期与 PID 限幅

## 变更总览
- 新增配置宏（驱动、零速模式、周期）：`Driver/ax_motor.h:36`
- 统一PWM周期与零速行为：`Driver/ax_motor.c:62, 104–138, 146–180, 212, 287–322, 256, 330–364`
- PID限幅与周期一致：`Robot/ax_speed.c:51–55, 81–85, 111–115, 141–145`
- `ax_speed.h` 引入周期宏依赖：`Robot/ax_speed.h:31`
- 编码器重映射：
  - A → `PA0/PA1@TIM5`：`Driver/ax_encoder.c:35–70, 77–90`
  - B → `PA6/PA7@TIM3`：`Driver/ax_encoder.c:98–140, 147–159`
  - C → `PA15/PB3@TIM2`：`Driver/ax_encoder.c:167–213, 220–233`
  - D 保持 `PD12/PD13@TIM4`：`Driver/ax_encoder.c:240–283, 290–303`

## 引脚映射
- 减速电机 PWM（CH1/CH2）：`TIM1@PE9/PE11/PE13/PE14`（不变）
- 编码器输入：
  - 编码器A：`PA0/PA1`（A0/A1）→ `TIM5`
  - 编码器B：`PA6/PA7`（A6/A7）→ `TIM3`
  - 编码器C：`PA15/PB3` → `TIM2`
  - 编码器D：`PD12/PD13` → `TIM4`

## 配置宏说明（`Driver/ax_motor.h`）
```c
#define MOTOR_DRV_TB6612 1
#define MOTOR_DRV_AT8236 2
#define MOTOR_DRIVER MOTOR_DRV_TB6612

#define MOTOR_ZERO_MODE_BRAKE 1
#define MOTOR_ZERO_MODE_COAST 2
#define MOTOR_ZERO_MODE MOTOR_ZERO_MODE_BRAKE

#define MOTOR_PWM_PERIOD 4200
```
- 切换驱动：修改 `MOTOR_DRIVER`
- 零速模式：
- 刹车：双路高（短路制动）
- 空转：双路低
- 周期：用于 `TIMx->ARR` 与速度限幅

## PWM 与 PID
- PWM 周期：`TIM1/TIM9/TIM12` 的 `Period` 使用 `MOTOR_PWM_PERIOD-1`
- 零速输出按 `MOTOR_ZERO_MODE`（A/B/C/D 四路已更新）
- PID 输出限幅为 `±MOTOR_PWM_PERIOD`
- 频率公式：`f_pwm ≈ f_tim / (PSC+1) / (ARR+1)`；当前 `TIM1/TIM9` `Prescaler=1`，`TIM12` `Prescaler=0`

## 使用与验证
- 调度周期：`Robot/main.c:126–145` 每 20 ms
- 验证：
  - 空载下发送直行/旋转指令，观察各轮 PWM 与编码器计数
  - 若方向与计数符号不一致，在 `Robot/ax_kinematics.c` 相应轮读数处调整符号（如 `R_Wheel_B.RT = -(...)`）
- 调整频率：修改 `MOTOR_PWM_PERIOD` 配合各定时器 `Prescaler`

## 注意事项
- 若板卡含 TB6612 `STBY` 引脚，请在初始化中拉高；可扩展 GPIO 接口以统一管理
- 高惯量场景优先使用空转模式，避免电流尖峰

## 变更动机
- 将周期与限幅集中为常量，降低硬编码
- 引脚映射与硬件引脚表对齐，减少接线与软件不一致成本
- 零速行为可配置为刹车或空转